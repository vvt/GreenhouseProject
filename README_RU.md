<h1>Контроллер теплицы на Arduino</h1>
<p>
Когда возник вопрос - <a href="https://github.com/Porokhnya/GreenhouseProject/wiki">здесь уже может быть половина ответа</a>. Вторая половина ответа, как правило, <a href="https://www.forumhouse.ru/threads/367227">расположена тут</a>.


<h1>Что умеет прошивка</h1>
<p>
 <ul>
  <li>Отсылать данные в облачные сервисы (ThingSpeak и <a href="http://gardenboss.ru" target="_blank">GardenBoss.ru</a>);</li>
  <li>Управляться и настраиваться посредством конфигуратора и веб-интерфейса;</li>
  <li>Получать внешние команды с сервиса <a href="http://gardenboss.ru" target="_blank">GardenBoss.ru</a>;</li>
  <li>Транслировать топики и управляться по протоколу MQTT;</li>
  <li>Управляться посредством SMS;</li>
  <li>Использовать разные шлюзы для связи с сетью: GSM/GPRS (SIM800), Wi-Fi (ESP8266), LAN (W5100);</li>
  <li>Работать с датчиками по разным интерфейсам - непосредственно подключаемые к контроллеру, по RS-485, 1-Wire, nRF, LoRa;</li>
  <li>Гибко настраиваться с помощью системы правил - ключевая концепция контроллера, когда пользователь сам определяет требуемое ему поведение системы;</li>
  <li>Работать с несколькими типами дисплеев - Nextion, LCD 128x64, 7'' TFT под Arduino Due;</li>
  <li>Работать с разными микроконтролерами: Arduino Mega, Arduino Due и любые платы на их основе;</li>
  <li>Настраиваться на практически любую конфигурацию железа: работать через расширители портов, включать/выключать модули из прошивки и т.п.;</li>
  <li>Работать практически со всеми распространёнными видами датчиков разных типов (влажность, температура, расход жидкости и т.п.);</li>
  <li>Получать дельты (разность) показаний датчиков любых физических типов (например, разность температур между DS18B20 и DHT22);</li>
  <li>Работать со списками резервирования для повышения отказоустойчивости системы: при помощи списков резервирования можно продублировать показания одного датчика другим, если какой-либо из датчиков группы резервирования выйдет из строя - при этом будет продолжена штатная работа правил;</li>
  <li>Работать с универсальными модулями: концепция, когда исполнительные механизмы и модули с датчиками физически вынесены на далёкое расстояние от контроллера по любому из поддерживаемых интерфейсов: 1-Wire, nRF, LoRa, RS-485;</li>
  <li>Собирать и накапливать информацию как на локальныю SD-карту (в виде лог-файлов), так и в веб-интерфейсе (база SQLite3) и на сервисе <a href="http://gardenboss.ru" target="_blank">GardenBoss.ru</a>, что позволяет выводить статистику в виде графиков;</li>
<li>Работать в режиме тревог, когда по срабатыванию какого-либо правила отправляется тревожная SMS;</li>
<li>Поддерживать обратную связь с универсальными исполнительными модулями, посредством правил (например, среагировать, если насос не включился);</li>
  <li>И ещё массу плюшек, вкусных, и - очень вкусных ;)</li>
 </ul>
 
<h1>ВНИМАНИЕ!</h1>
Перед закачиванием прошивки в контроллер её необходимо настроить, все настройки в файле `Globals.h`! Я тестирую и выкладываю прошивку практически <b>в максимальной конфигурации</b>, следовательно, вы должны исключить из прошивки те модули, которым нет соответствия в виде подключённых железных "ответок". Скажем, если у вас нет модуля SD-карты, то совершенно недопустимо включать в прошивку модуль логгирования информации (`USE_LOG_MODULE`) и модуль Wi-Fi (`USE_WIFI_MODULE`). Также хочу обратить внимание на то, что некоторые модули для своей нормальной работы требуют подключённого железного соратника DS3231, т.к. без модуля реального времени их штатная работа невозможна. При любых затруднениях в работе (прошивка не работает как надо, почему-то ничего не получается, что-то не выводится на экран) - прежде всего смотрите настройки прошивки и схему подключения. Подчёркиваю - предложенная прошивка не готовое решение, а конструктор, который вы можете настроить под свои нужды. И, как любое модульное изделие, требует вдумчивого подхода перед началом использования.
<p>
<h1>Лицензия</h1>
Проект свободен для <b>некоммерческого использования</b> и исключительно в личных целях. Любое другое использование, например, встраивание любой части кода в коммерческий продукт, распространение любой части исходных кодов на сторонних ресурсах без разрешения автора проекта - не допускается. Все права интеллектуальной собственности на любую программную часть продукта принадлежат их авторам, использование программного кода в сторонних проектах без согласия авторов и упоминания об исходном авторстве - не допускается.

Автор проекта оставляет за собой право в любой момент пересмотреть лицензию распространения продукта.

<h1>Структура архива</h1>
<ul>
<li>Версия Arduino IDE, используемая в проекте - <b>1.8.5</b>;</li>
<li>В папке <b>Main</b> - исходники прошивки для Меги;</li>
<li>В папке <b>ESP_BIN</b> - прошивка для ESP8266;</li>
<li>В папке <b>SOFT</b> - текущая версия конфигуратора, коннектится к Меге по COM-порту;</li>
<li>В папке <b>Libraries</b> - сторонние библиотеки, искользуемые в проекте (их количество неуклонно приближается к нулю, но пока - как есть);</li>
<li>В папке <b>SD</b> - файлы, которые надо закачать на SD-карту;</li>
<li>Файл <b>NewPlan_ru.spl7</b> - файл схемы для программы SPlan 7.0;</li>
<li>В папке <b>Nextion</b> - файл прошивки для дисплея Nextion 320x240, и проект прошивки;</li>
<li>В папке <b>UniversalSensorsModule</b> - прошивка универсального модуля с поддержкой до трёх датчиков разных типов, работающего по шине 1-Wire, по шине RS-485, и по радиоканалу, через nRF24L01+ и LoRa;</li>
<li>В папке <b>UniversalExecutionModule</b> - прошивка универсального исполнительного модуля на 8 слотов настраиваемых привязок, работающего по шине 1-Wire, по шине RS-485, и по радиоканалу, через nRF24L01+ и LoRa;</li>
<li>В папке <b>FrequencySoilMoistureSensor</b> - прошивка для опроса частотного датчика влажности почвы;</li>
<li>В папке <b>WEB</b> - текущая версия вебморды, ставится под любой веб-сервер с поддержкой PHP и sqlite3.</li>
</ul>

<h1>Настройки прошивки по умолчанию</h1>

Выкладываемая прошивка - это слепок того, что я делаю на текущий момент. Поэтому её настройки по умолчанию могут сильно разниться с теми, которые нужны вам. Примерная конфигурация, которая собрана у меня на макетке на текущий момент:

<details> 
<summary><b>Кликните, чтобы посмотреть...</b><br/><br/></summary>

  * `USE_UNIVERSAL_SENSORS` - модуль поддержки универсальных модулей (в разработке, подключен эмулятор на Uno);
  * `USE_UNI_NEXTION_MODULE` - модуль поддержки дисплея Nextion по шине 1-Wire;
  * `USE_DS3231_REALTIME_CLOCK` - подключён модуль часов реального времени DS3231;
  * `USE_TEMP_SENSORS` - модуль хранения информации о температуре и управления фрамугами, подключены DS18B20 и восьмиканальный модуль реле;
  * `USE_WINDOWS_SHIFT_REGISTER` - управление фрамугами идёт через сдвиговый регистр 74HC595;
  * `USE_WATERING_MODULE` - модуль управления поливом, подключен железный модуль реле на два канала;
  * `USE_LUMINOSITY_MODULE` - модуль досветки, подключёны два датчика BH1750, требуется железный модуль реле на один канал;
  * `USE_HUMIDITY_MODULE` - модуль влажности, подключены DHT22 и Si7021;
  * `USE_SOIL_MOISTURE_MODULE` - модуль влажности почвы, пока подключён китайский влагомер;
  * `USE_LOG_MODULE` - модуль логгирования информации, подключен железный SD-модуль;
  * `USE_TIMER_MODULE` - модуль таймеров (4 таймера периодических операций);
  * `USE_RESERVATION_MODULE` - модуль резервирования показаний датчиков (когда датчики одной группы дублируют друг друга);
  * `USE_WATERFLOW_MODULE` - модуль расхода воды, подключён китайский расходомер;
  * `USE_WIFI_MODULE` - модуль доступа по WI-FI, подключена ESP8266, требует подключение SD-модуля;
  * `USE_LCD_MODULE` - модуль экрана, подключён графический LCD 128x64 на контроллере ST7920, а также тактовая кнопка и энкодер;
  * Определено ещё кучу всяких `USE_*`, поэтому, прошу вас - будьте внимательны с настройками прошивки, ибо перечислять их здесь все - анрил полный;
  * Конвертеры уровней, DC-DC-преобразователи - подключены там, где это требуется;
  * Подключён SIM800L, директива `USE_SMS_MODULE` раскомментирована;
  * Модули реле у меня включаются по низкому уровню;
  * К Меге у меня подключен как минимум один универсальный модуль, для тестирования работы по 1-Wire и RS-485.
</details>

Настройки прошивки по умолчанию могут меняться с обновлениями, поэтому будьте внимательны, и проверяйте, пожалуйста,
соответствие настроек прошивки вашим чаяниям. Обращаю внимание, что прошивку можно настроить и на другой экран (Nextion), и
на другой шлюз в локальную сеть (W5100), можно менять кол-во датчиков, номера пинов для них, можно управлять пинами реле фрамуг 
напрямую, а не через сдвиговый регистр - всё это шаманство вы можете совершить, чтобы подогнать прошивку под ваши требования. Я 
лишь даю инструмент, которым можно (и нужно) воспользоваться с умом.

<br/>
<h1>Скриншоты конфигуратора</h1>

<details> 
<summary><b>Кликните, чтобы посмотреть...</b><br/><br/></summary>
  
<img src="screen1.png" hspace='10'/>
<img src="screen2.png" hspace='10'/>
<img src="screen3.png" hspace='10'/>
<img src="screen4.png" hspace='10'/>
<img src="screen5.png" hspace='10'/>
<img src="screen6.png" hspace='10'/>
<img src="screen7.png" hspace='10'/>
<img src="screen8.png" hspace='10'/>
<img src="screen9.png" hspace='10'/>
<img src="screen10.png" hspace='10'/>
<img src="screen11.png" hspace='10'/>
<img src="screen12.png" hspace='10'/>
<img src="screen13.png" hspace='10'/>
<img src="screen14.png" hspace='10'/>
<img src="screen15.png" hspace='10'/>
<img src="screen16.png" hspace='10'/>

</details>

<p>
<h1>Как использовать</h1>
<ul>
<li><b>Установить библиотеки (в папке Libraries архива) в среду Arduino IDE!</b></li>
<li><b>ВНИМАТЕЛЬНО ПРОЧИТАТЬ ВСЕ ИНСТРУКЦИИ, РАСПОЛОЖЕННЫЕ СВЕРХУ В ФАЙЛЕ MAIN.INO!!!</b></li>
<li><b>Все настройки прошивки перед компиляцией - в файле Globals.h!</b></li>
</ul>
<p>
Распаковать архив в папку на диске, установить библиотеки из папки <b>Libraries</b> архива в среду Arduino IDE. Затем открыть в Arduino IDE файл <b>Main.ino</b>, настроить директивы условной компиляции (файл `Globals.h`), скомпилировать прошивку и закачать в Мегу. Подсоединить железки в зависимости от выбранных настроек прошивки. <b>Если используется модуль Wi-Fi или модуль логгирования информации - подключить модуль SD-карты и закачать файлы из папки SD в корень SD-карточки!</b>
<p>
Открыть конфигуратор и подключиться к COM-порту, на котором висит Мега, и начать общение с контроллером. Принципиальная схема подключения некоторого железного добра указана ниже (<b>обратите внимание</b>, что схема - это не конкретное руководство, а лишь <b>ПРИМЕР</b> подключения, т.к. прошивка очень гибко настраивается):<br/>
<img src="plan.png"/>

<h1>Программные модули</h1>

Их - вагон и тележка, поэтому описывать их все здесь - непрактично. Для понимания того, нужен ли вам тот или иной модуль - всегда есть комментарии в файле настроек прошивки ;)

<h1>Конфигуратор</h1>

Конфигуратор автоматически подцепляет прошитые в контроллер модули, и показывает вкладки управления этими модулями, после соединения с контроллером. Если вы не видите вкладку управления поливом (например) - смотрите директивы условной компиляции на предмет того, выключен ли модуль из компиляции или нет. 
<p>

<h1>Веб-интерфейс</h1>

Ставится под любой веб-сервер с поддержкой PHP не ниже 5.6 и базы данных SQLite3, все его исходники - в папке WEB архива с проектом.

<h1>Концепция "не навреди"</h1>

При перезагрузке контроллера он <b>ВСЕГДА</b> переходит в автоматический режим работы, даже если при последнем обращении к нему был выставлен ручной режим. Также при наступлении нового дня недели переходит в автоматический режим работы модуль полива. Такой вид поведения был реализован сознательно.
